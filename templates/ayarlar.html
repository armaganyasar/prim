<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Takvim Ayarları</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .color-picker {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .settings-card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .preview-box {
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .color-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container my-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-cog text-primary"></i> Takvim Ayarları</h2>
                <p class="text-muted mb-0">Randevu takvimi görünümünü kişiselleştirin</p>
            </div>
            <div>
                <button class="btn btn-success me-2" id="saveSettings">
                    <i class="fas fa-save"></i> Kaydet
                </button>
                <a href="/randevu" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Takvime Dön
                </a>
            </div>
        </div>

        <div class="row">
            <!-- Ayarlar -->
            <div class="col-lg-8">
                <!-- Temel Görünüm Ayarları -->
                <div class="card settings-card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-eye text-info"></i> Görünüm Ayarları</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Varsayılan Görünüm</label>
                                <select class="form-select" id="defaultView">
                                    <option value="dayGridMonth">Aylık Görünüm</option>
                                    <option value="timeGridWeek">Haftalık Görünüm</option>
                                    <option value="timeGridDay">Günlük Görünüm</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Haftanın Başlangıcı</label>
                                <select class="form-select" id="weekStart">
                                    <option value="1">Pazartesi</option>
                                    <option value="0">Pazar</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Başlangıç Saati</label>
                                <select class="form-select" id="startTime">
                                    <option value="00:00">00:00 (Gece Yarısı)</option>
                                    <option value="01:00">01:00</option>
                                    <option value="02:00">02:00</option>
                                    <option value="03:00">03:00</option>
                                    <option value="04:00">04:00</option>
                                    <option value="05:00">05:00</option>
                                    <option value="06:00">06:00</option>
                                    <option value="07:00">07:00</option>
                                    <option value="08:00">08:00</option>
                                    <option value="09:00">09:00</option>
                                    <option value="10:00">10:00</option>
                                    <option value="11:00">11:00</option>
                                    <option value="12:00">12:00 (Öğle)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Bitiş Saati</label>
                                <select class="form-select" id="endTime">
                                    <option value="12:00">12:00 (Öğle)</option>
                                    <option value="13:00">13:00</option>
                                    <option value="14:00">14:00</option>
                                    <option value="15:00">15:00</option>
                                    <option value="16:00">16:00</option>
                                    <option value="17:00">17:00</option>
                                    <option value="18:00">18:00</option>
                                    <option value="19:00">19:00</option>
                                    <option value="20:00">20:00</option>
                                    <option value="21:00">21:00</option>
                                    <option value="22:00">22:00</option>
                                    <option value="23:00">23:00</option>
                                    <option value="23:59">23:59 (Gece Yarısı)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Zaman Dilimi</label>
                                <select class="form-select" id="slotDuration">
                                    <option value="15">15 Dakika</option>
                                    <option value="30">30 Dakika</option>
                                    <option value="60">60 Dakika</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showWeekends" checked>
                                    <label class="form-check-label" for="showWeekends">
                                        Hafta sonlarını göster
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showAllDay">
                                    <label class="form-check-label" for="showAllDay">
                                        Tam gün etkinlik alanını göster
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Renk Ayarları -->
                <div class="card settings-card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-palette text-warning"></i> Renk Ayarları</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Normal Randevu Rengi</label>
                                <div class="d-flex align-items-center">
                                    <input type="color" class="color-picker me-2" id="appointmentColor" value="#0d6efd">
                                    <span class="text-muted">Standart randevular için</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Acil Randevu Rengi</label>
                                <div class="d-flex align-items-center">
                                    <input type="color" class="color-picker me-2" id="urgentColor" value="#dc3545">
                                    <span class="text-muted">Acil durumlar için</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tamamlanan Randevu Rengi</label>
                                <div class="d-flex align-items-center">
                                    <input type="color" class="color-picker me-2" id="completedColor" value="#198754">
                                    <span class="text-muted">Bitmiş randevular</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">İptal Edilen Randevu Rengi</label>
                                <div class="d-flex align-items-center">
                                    <input type="color" class="color-picker me-2" id="cancelledColor" value="#6c757d">
                                    <span class="text-muted">İptal olan randevular</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dil ve Format Ayarları -->
                <div class="card settings-card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-globe text-success"></i> Dil ve Format</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Dil</label>
                                <select class="form-select" id="language">
                                    <option value="tr">Türkçe</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Saat Formatı</label>
                                <select class="form-select" id="timeFormat">
                                    <option value="24">24 Saat (14:30)</option>
                                    <option value="12">12 Saat (2:30 PM)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tarih Formatı</label>
                                <select class="form-select" id="dateFormat">
                                    <option value="DD.MM.YYYY">GG.AA.YYYY</option>
                                    <option value="DD/MM/YYYY">GG/AA/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-AA-GG</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Önizleme ve Kontroller -->
            <div class="col-lg-4">
                <div class="sticky-top">
                    <!-- Önizleme -->
                    <div class="card settings-card mb-4">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-eye"></i> Önizleme</h5>
                        </div>
                        <div class="card-body">
                            <div class="preview-box mb-3">
                                <i class="fas fa-calendar fa-3x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Takvim Önizlemesi</p>
                            </div>

                            <!-- Mevcut Ayarlar -->
                            <div class="bg-light p-3 rounded">
                                <h6 class="fw-bold mb-2">Mevcut Ayarlar:</h6>
                                <ul class="list-unstyled small mb-0">
                                    <li><strong>Görünüm:</strong> <span id="previewView">Aylık</span></li>
                                    <li><strong>Çalışma:</strong> <span id="previewHours">08:00 - 18:00</span></li>
                                    <li><strong>Zaman Dilimi:</strong> <span id="previewSlot">30 dakika</span></li>
                                    <li><strong>Hafta Sonu:</strong> <span id="previewWeekend">Gösteriliyor</span></li>
                                </ul>
                            </div>

                            <!-- Renk Örnekleri -->
                            <div class="mt-3">
                                <h6 class="fw-bold mb-2">Renk Örnekleri:</h6>
                                <div class="d-flex flex-column gap-1">
                                    <div><span class="color-preview" id="normalPreview" style="background-color: #0d6efd;"></span>Normal Randevu</div>
                                    <div><span class="color-preview" id="urgentPreview" style="background-color: #dc3545;"></span>Acil Randevu</div>
                                    <div><span class="color-preview" id="completedPreview" style="background-color: #198754;"></span>Tamamlanan</div>
                                    <div><span class="color-preview" id="cancelledPreview" style="background-color: #6c757d;"></span>İptal Edilen</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Kontrol Butonları -->
                    <div class="card settings-card">
                        <div class="card-body">
                            <button class="btn btn-warning w-100 mb-2" id="resetSettings">
                                <i class="fas fa-undo"></i> Varsayılan Ayarlara Dön
                            </button>
                            <button class="btn btn-info w-100" id="testSettings">
                                <i class="fas fa-play"></i> Ayarları Test Et
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ayarları yükle
            loadSettings();

            // Event listeners
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            document.getElementById('resetSettings').addEventListener('click', resetSettings);
            document.getElementById('testSettings').addEventListener('click', testSettings);

            // Önizleme güncellemeleri
            ['defaultView', 'startTime', 'endTime', 'slotDuration', 'showWeekends'].forEach(id => {
                document.getElementById(id).addEventListener('change', updatePreview);
            });

            // Renk değişikliklerini dinle
            ['appointmentColor', 'urgentColor', 'completedColor', 'cancelledColor'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateColorPreview);
            });

            async function loadSettings() {
                try {
                    const response = await fetch('/api/calendar/settings');
                    if (response.ok) {
                        const result = await response.json();
                        const settings = result.settings || {};
                        
                        // Form alanlarını doldur
                        if (settings.defaultView) document.getElementById('defaultView').value = settings.defaultView;
                        if (settings.startTime) document.getElementById('startTime').value = settings.startTime;
                        if (settings.endTime) document.getElementById('endTime').value = settings.endTime;
                        if (settings.slotDuration) document.getElementById('slotDuration').value = settings.slotDuration;
                        if (settings.weekStart) document.getElementById('weekStart').value = settings.weekStart;
                        if (settings.language) document.getElementById('language').value = settings.language;
                        if (settings.timeFormat) document.getElementById('timeFormat').value = settings.timeFormat;
                        if (settings.dateFormat) document.getElementById('dateFormat').value = settings.dateFormat;
                        
                        document.getElementById('showWeekends').checked = settings.showWeekends !== false;
                        document.getElementById('showAllDay').checked = settings.showAllDay || false;
                        
                        // Renkleri ayarla
                        if (settings.appointmentColor) document.getElementById('appointmentColor').value = settings.appointmentColor;
                        if (settings.urgentColor) document.getElementById('urgentColor').value = settings.urgentColor;
                        if (settings.completedColor) document.getElementById('completedColor').value = settings.completedColor;
                        if (settings.cancelledColor) document.getElementById('cancelledColor').value = settings.cancelledColor;
                        
                        updatePreview();
                        updateColorPreview();
                    }
                } catch (error) {
                    console.error('Ayarlar yüklenirken hata:', error);
                    showNotification('Ayarlar yüklenirken hata oluştu', 'error');
                }
            }

            async function saveSettings() {
                const settings = {
                    defaultView: document.getElementById('defaultView').value,
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    slotDuration: document.getElementById('slotDuration').value,
                    weekStart: document.getElementById('weekStart').value,
                    language: document.getElementById('language').value,
                    timeFormat: document.getElementById('timeFormat').value,
                    dateFormat: document.getElementById('dateFormat').value,
                    showWeekends: document.getElementById('showWeekends').checked,
                    showAllDay: document.getElementById('showAllDay').checked,
                    appointmentColor: document.getElementById('appointmentColor').value,
                    urgentColor: document.getElementById('urgentColor').value,
                    completedColor: document.getElementById('completedColor').value,
                    cancelledColor: document.getElementById('cancelledColor').value,
                    branchColors: []
                };

                try {
                    const response = await fetch('/api/calendar/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('Ayarlar başarıyla kaydedildi!', 'success');
                    } else {
                        showNotification('Ayarlar kaydedilirken hata oluştu: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Kaydetme hatası:', error);
                    showNotification('Bağlantı hatası oluştu', 'error');
                }
            }

            async function resetSettings() {
                if (confirm('Tüm ayarları varsayılan değerlere döndürmek istediğinizden emin misiniz?')) {
                    try {
                        const response = await fetch('/api/calendar/reset', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            showNotification('Ayarlar sıfırlandı', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showNotification('Sıfırlama sırasında hata oluştu', 'error');
                        }
                    } catch (error) {
                        console.error('Sıfırlama hatası:', error);
                        showNotification('Bağlantı hatası', 'error');
                    }
                }
            }

            function testSettings() {
                showNotification('Ayarlar test ediliyor...', 'info');
                setTimeout(() => {
                    showNotification('Test tamamlandı! Takvime gidip sonuçları görebilirsiniz.', 'success');
                }, 1000);
            }

            function updatePreview() {
                const view = document.getElementById('defaultView').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const slotDuration = document.getElementById('slotDuration').value;
                const showWeekends = document.getElementById('showWeekends').checked;

                const viewText = {
                    'dayGridMonth': 'Aylık',
                    'timeGridWeek': 'Haftalık',
                    'timeGridDay': 'Günlük'
                }[view];

                document.getElementById('previewView').textContent = viewText;
                document.getElementById('previewHours').textContent = `${startTime} - ${endTime}`;
                document.getElementById('previewSlot').textContent = `${slotDuration} dakika`;
                document.getElementById('previewWeekend').textContent = showWeekends ? 'Gösteriliyor' : 'Gizli';
            }

            function updateColorPreview() {
                document.getElementById('normalPreview').style.backgroundColor = document.getElementById('appointmentColor').value;
                document.getElementById('urgentPreview').style.backgroundColor = document.getElementById('urgentColor').value;
                document.getElementById('completedPreview').style.backgroundColor = document.getElementById('completedColor').value;
                document.getElementById('cancelledPreview').style.backgroundColor = document.getElementById('cancelledColor').value;
            }

            function showNotification(message, type = 'info') {
                const alertClass = type === 'error' ? 'alert-danger' : 
                                  type === 'success' ? 'alert-success' : 
                                  type === 'warning' ? 'alert-warning' : 'alert-info';
                
                const alert = document.createElement('div');
                alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
                alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(alert);
                
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>