<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prim Özeti - Yazdır</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .page-break { page-break-after: always; }
        }
        
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 12px; }
        
        .print-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .table-header-lab { background-color: #17a2b8 !important; color: white !important; }
        .table-header-implant { background-color: #ffc107 !important; color: #000 !important; }
        .table-header-diger { background-color: #28a745 !important; color: white !important; }
        .gider-row-lab { border-left: 4px solid #17a2b8; }
        .gider-row-implant { border-left: 4px solid #ffc107; }
        .gider-row-diger { border-left: 4px solid #28a745; }
        
        .section-title {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        @page { size: A4; margin: 1cm; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="no-print text-end mb-3">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> Yazdır
            </button>
            <button onclick="window.close()" class="btn btn-secondary">
                <i class="fas fa-times"></i> Kapat
            </button>
        </div>

        <div class="print-header">
            <h2 class="mb-0"><i class="fas fa-calculator"></i> PRİM HESAPLAMA ÖZETİ</h2>
            <p class="mb-0">Detaylı Prim Raporu</p>
        </div>

        {% if detay and detay.prim %}
        {% set prim = detay.prim %}
        {% set tahsilat = detay.tahsilat or [] %}
        {% set laboratuvar_giderleri = detay.laboratuvar_giderleri or [] %}
        {% set implant_giderleri = detay.implant_giderleri or [] %}
        {% set diger_giderler = detay.diger_giderler or [] %}
        {% set net_ciro_eklemeleri = detay.net_ciro_eklemeleri or [] %}
        {% set hakedis_eklemeleri = detay.hakedis_eklemeleri or [] %}

        <div class="info-box">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Hekim:</strong> {{ prim.doktor_adi }}</p>
                    <p><strong>Şube:</strong> {{ prim.sube_adi }}</p>
                    <p><strong>Dönem:</strong> {{ prim.donem_baslangic }} - {{ prim.donem_bitis }}</p>
                </div>
                <div class="col-md-6 text-end">
                    <p><strong>Prim ID:</strong> #{{ prim.id }}</p>
                    <p><strong>Hesaplama Tarihi:</strong> {{ prim.olusturma_tarihi }}</p>
                    <p><strong>Hesaplayan:</strong> {{ prim.olusturan_kullanici or 'Sistem' }}</p>
                </div>
            </div>
        </div>

        <div class="summary-box mb-4">
            <div class="row">
                <div class="col-md-4">
                    <h6>Brüt Tahsilat</h6>
                    <h4>{{ "%.2f"|format(prim.brut_tahsilat or 0) }} ₺</h4>
                </div>
                <div class="col-md-4">
                    <h6>Net Tahsilat</h6>
                    <h4>{{ "%.2f"|format(prim.net_tahsilat or 0) }} ₺</h4>
                    <small>(-{{ "%.2f"|format(prim.toplam_kesinti or 0) }} ₺ kesinti)</small>
                </div>
                <div class="col-md-4">
                    <h6>Toplam Gider</h6>
                    <h4>{{ "%.2f"|format(prim.toplam_gider or 0) }} ₺</h4>
                </div>
            </div>
            <hr class="border-light my-3">
            <div class="row">
                <div class="col-md-6">
                    <h6>Prim Matrahı</h6>
                    <h3>{{ "%.2f"|format(prim.prim_matrah or 0) }} ₺</h3>
                </div>
                <div class="col-md-6">
                    <h5>HESAPLANAN PRİM (%{{ prim.prim_orani or 0 }})</h5>
                    <h2>{{ "%.2f"|format(prim.hesaplanan_prim or 0) }} ₺</h2>
                </div>
            </div>
        </div>

        {% if tahsilat and tahsilat|length > 0 %}
        <div class="section-title">
            <i class="fas fa-money-bill-wave"></i> TAHSİLAT DETAYLARI ({{ tahsilat|length }} adet)
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Tarih</th>
                        <th>Hasta</th>
                        <th>Ödeme Şekli</th>
                        <th class="text-end">Brüt Tutar</th>
                        <th>Taksit</th>
                        <th class="text-end">Kesinti</th>
                        <th class="text-end">Net Tutar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tahsilat %}
                    <tr>
                        <td>{{ t.tarih or '-' }}</td>
                        <td>{{ t.hasta_adi or '-' }}</td>
                        <td><span class="badge bg-info">{{ t.odeme_sekli or '-' }}</span></td>
                        <td class="text-end">{{ "%.2f"|format(t.brut_tutar or 0) }} ₺</td>
                        <td>{{ t.taksit_sayisi or 1 }}{% if (t.taksit_sayisi or 1) > 1 %} taksit{% else %} (peşin){% endif %}</td>
                        <td class="text-end text-warning">-{{ "%.2f"|format(t.taksit_kesinti_tutari or 0) }} ₺</td>
                        <td class="text-end fw-bold">{{ "%.2f"|format(t.net_tutar or 0) }} ₺</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="3"><strong>TOPLAM</strong></td>
                        <td class="text-end fw-bold">{{ "%.2f"|format(prim.brut_tahsilat or 0) }} ₺</td>
                        <td></td>
                        <td class="text-end fw-bold text-warning">-{{ "%.2f"|format(prim.toplam_kesinti or 0) }} ₺</td>
                        <td class="text-end fw-bold text-success">{{ "%.2f"|format(prim.net_tahsilat or 0) }} ₺</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}

        <div class="page-break"></div>

        {% set toplam_lab = 0 %}
        {% set toplam_implant = 0 %}
        {% set toplam_diger = 0 %}
        {% set toplam_net_ciro = 0 %}
        {% set toplam_hakedis = 0 %}
        
        {% if laboratuvar_giderleri %}
            {% for g in laboratuvar_giderleri %}
                {% set toplam_lab = toplam_lab + (g.tutar or 0) %}
            {% endfor %}
        {% endif %}
        
        {% if implant_giderleri %}
            {% for g in implant_giderleri %}
                {% set toplam_implant = toplam_implant + (g.tutar or 0) %}
            {% endfor %}
        {% endif %}
        
        {% if diger_giderler %}
            {% for g in diger_giderler %}
                {% set toplam_diger = toplam_diger + (g.tutar or 0) %}
            {% endfor %}
        {% endif %}

        {% if net_ciro_eklemeleri %}
            {% for item in net_ciro_eklemeleri %}
                {% set toplam_net_ciro = toplam_net_ciro + (item.tutar or 0) %}
            {% endfor %}
        {% endif %}

        {% if hakedis_eklemeleri %}
            {% for item in hakedis_eklemeleri %}
                {% set toplam_hakedis = toplam_hakedis + (item.tutar or 0) %}
            {% endfor %}
        {% endif %}
        
        {% set toplam_gider_all = toplam_lab + toplam_implant + toplam_diger %}

        {% if toplam_gider_all > 0 %}
        <div class="section-title">
            <i class="fas fa-receipt"></i> GİDERLER DETAYI
        </div>

        {% if laboratuvar_giderleri and laboratuvar_giderleri|length > 0 %}
        <h6 class="mt-3 text-info"><i class="fas fa-flask"></i> Laboratuvar Giderleri</h6>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead class="table-header-lab">
                    <tr>
                        <th>Tarih</th>
                        <th>Hasta</th>
                        <th>İşlem</th>
                        <th class="text-end">Tutar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for g in laboratuvar_giderleri %}
                    <tr class="gider-row-lab">
                        <td>{{ g.tarih or '-' }}</td>
                        <td>{{ g.hasta_adi or '-' }}</td>
                        <td>{{ g.islem or '-' }}</td>
                        <td class="text-end fw-bold text-info">{{ "%.2f"|format(g.tutar or 0) }} ₺</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="3"><strong>Laboratuvar Toplamı</strong></td>
                        <td class="text-end fw-bold text-info">{{ "%.2f"|format(toplam_lab) }} ₺</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}

        {% if implant_giderleri and implant_giderleri|length > 0 %}
        <h6 class="mt-3 text-warning"><i class="fas fa-tooth"></i> İmplant Giderleri</h6>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead class="table-header-implant">
                    <tr>
                        <th>Tarih</th>
                        <th>Hasta</th>
                        <th>Marka</th>
                        <th>Boy / Çap</th>
                        <th>Adet</th>
                        <th class="text-end">Tutar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for g in implant_giderleri %}
                    <tr class="gider-row-implant">
                        <td>{{ g.tarih or '-' }}</td>
                        <td>{{ g.hasta_adi or '-' }}</td>
                        <td>{{ g.implant_markasi or '-' }}</td>
                        <td>{{ g.boy or '-' }} / {{ g.cap or '-' }}</td>
                        <td>{{ g.adet or 0 }} {{ g.birim or 'adet' }}</td>
                        <td class="text-end fw-bold text-warning">{{ "%.2f"|format(g.tutar or 0) }} ₺</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="5"><strong>İmplant Toplamı</strong></td>
                        <td class="text-end fw-bold text-warning">{{ "%.2f"|format(toplam_implant) }} ₺</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}

        {% if diger_giderler and diger_giderler|length > 0 %}
        <h6 class="mt-3 text-success"><i class="fas fa-file-invoice"></i> Diğer Giderler</h6>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead class="table-header-diger">
                    <tr>
                        <th>Hasta</th>
                        <th>Kategori</th>
                        <th class="text-end">Tutar</th>
                        <th>Açıklama</th>
                    </tr>
                </thead>
                <tbody>
                    {% for g in diger_giderler %}
                    <tr class="gider-row-diger">
                        <td>{{ g.hasta_adi or '-' }}</td>
                        <td><span class="badge bg-secondary">{{ g.kategori or '-' }}</span></td>
                        <td class="text-end fw-bold text-success">{{ "%.2f"|format(g.tutar or 0) }} ₺</td>
                        <td>{{ g.aciklama or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="2"><strong>Diğer Gider Toplamı</strong></td>
                        <td class="text-end fw-bold text-success">{{ "%.2f"|format(toplam_diger) }} ₺</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}

        <div class="alert alert-danger mt-3">
            <div class="row text-center">
                <div class="col-3">
                    <strong>Laboratuvar:</strong><br>
                    <h5>{{ "%.2f"|format(toplam_lab) }} ₺</h5>
                </div>
                <div class="col-3">
                    <strong>İmplant:</strong><br>
                    <h5>{{ "%.2f"|format(toplam_implant) }} ₺</h5>
                </div>
                <div class="col-3">
                    <strong>Diğer:</strong><br>
                    <h5>{{ "%.2f"|format(toplam_diger) }} ₺</h5>
                </div>
                <div class="col-3">
                    <strong>TOPLAM GİDER:</strong><br>
                    <h4 class="mb-0">{{ "%.2f"|format(toplam_gider_all) }} ₺</h4>
                </div>
            </div>
        </div>
        {% endif %}

        {# YENİ: NET CİRO EKLEMELERİ #}
        {% if net_ciro_eklemeleri and net_ciro_eklemeleri|length > 0 %}
        <div class="section-title" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
            <i class="fas fa-plus-circle"></i> NET CİRO EKLEMELERİ
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead style="background-color: #38ef7d !important; color: white !important;">
                    <tr>
                        <th>Tarih</th>
                        <th>Açıklama</th>
                        <th>Kategori</th>
                        <th class="text-end">Tutar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in net_ciro_eklemeleri %}
                    <tr style="border-left: 4px solid #38ef7d;">
                        <td>{{ item.tarih or '-' }}</td>
                        <td>{{ item.aciklama or '-' }}</td>
                        <td><span class="badge bg-success">{{ item.kategori or 'diger' }}</span></td>
                        <td class="text-end fw-bold" style="color: #38ef7d;">{{ "%.2f"|format(item.tutar or 0) }} ₺</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="3"><strong>Net Ciro Ekleme Toplamı</strong></td>
                        <td class="text-end fw-bold" style="color: #38ef7d; font-size: 1.2em;">{{ "%.2f"|format(toplam_net_ciro) }} ₺</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}

        {# YENİ: HAK EDİŞ EKLEMELERİ #}
        {% if hakedis_eklemeleri and hakedis_eklemeleri|length > 0 %}
        <div class="section-title" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <i class="fas fa-hand-holding-usd"></i> HAK EDİŞ EKLEMELERİ
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-bordered">
                <thead style="background-color: #764ba2 !important; color: white !important;">
                    <tr>
                        <th>Tarih</th>
                        <th>Açıklama</th>
                        <th>Kategori</th>
                        <th class="text-end">Tutar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in hakedis_eklemeleri %}
                    <tr style="border-left: 4px solid #764ba2;">
                        <td>{{ item.tarih or '-' }}</td>
                        <td>{{ item.aciklama or '-' }}</td>
                        <td><span class="badge bg-primary">{{ item.kategori or 'bonus' }}</span></td>
                        <td class="text-end fw-bold" style="color: #764ba2;">{{ "%.2f"|format(item.tutar or 0) }} ₺</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="3"><strong>Hak Ediş Ekleme Toplamı</strong></td>
                        <td class="text-end fw-bold" style="color: #764ba2; font-size: 1.2em;">{{ "%.2f"|format(toplam_hakedis) }} ₺</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endif %}

        <div class="text-center mt-4 text-muted">
            <small>Bu belge otomatik olarak oluşturulmuştur.</small>
        </div>

        {% else %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> Prim detayları bulunamadı.
        </div>
        {% endif %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>