<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İzin Yönetimi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .ozet-card {
            transition: transform 0.2s;
            border-left: 4px solid;
        }
        .ozet-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .izin-yillik { border-left-color: #28a745; }
        .izin-ucretsiz { border-left-color: #dc3545; }
        .izin-hastalik { border-left-color: #ffc107; }
        .izin-mazeret { border-left-color: #17a2b8; }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-calendar-check text-info"></i> İzin Yönetimi</h2>
                        <p class="text-muted mb-0">Personel izin takibi ve yönetimi</p>
                    </div>
                    <div>
                        <button class="btn btn-success me-2" onclick="excelExport()">
                            <i class="fas fa-file-excel"></i> Excel İndir
                        </button>
                        <button class="btn btn-primary me-2" onclick="yeniIzinModal()">
                            <i class="fas fa-plus"></i> Yeni İzin Ekle
                        </button>
                        <a href="/personel" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-users"></i> Personel
                        </a>
                        <a href="/" class="btn btn-outline-primary">
                            <i class="fas fa-home"></i> Ana Sayfa
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtreler -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Personel</label>
                        <select class="form-select" id="filterPersonel">
                            <option value="">Tüm Personel</option>
                            {% for p in personeller %}
                            <option value="{{ p.id }}">{{ p.ad }} {{ p.soyad }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">İzin Tipi</label>
                        <select class="form-select" id="filterIzinTipi">
                            <option value="">Tümü</option>
                            <option value="yillik">Yıllık İzin</option>
                            <option value="ucretsiz">Ücretsiz İzin</option>
                            <option value="hastalik">Hastalık İzni</option>
                            <option value="mazeret">Mazeret İzni</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Başlangıç</label>
                        <input type="date" class="form-control" id="filterBaslangic">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Bitiş</label>
                        <input type="date" class="form-control" id="filterBitis">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Yıl</label>
                        <select class="form-select" id="filterYil"></select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="izinListele()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Özet Kartlar -->
        <div class="row mb-4" id="ozetKartlar">
            <div class="col-md-3">
                <div class="card ozet-card izin-yillik">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Yıllık İzin</h6>
                                <h3 class="mb-0" id="ozetYillik">0</h3>
                                <small class="text-success">Kullanılan / Kalan</small>
                            </div>
                            <div class="text-success">
                                <i class="fas fa-calendar-check fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card ozet-card izin-ucretsiz">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Ücretsiz İzin</h6>
                                <h3 class="mb-0" id="ozetUcretsiz">0 gün</h3>
                                <small class="text-danger">Kesintili</small>
                            </div>
                            <div class="text-danger">
                                <i class="fas fa-calendar-times fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card ozet-card izin-hastalik">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Hastalık İzni</h6>
                                <h3 class="mb-0" id="ozetHastalik">0 gün</h3>
                                <small class="text-warning">Toplam</small>
                            </div>
                            <div class="text-warning">
                                <i class="fas fa-notes-medical fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card ozet-card izin-mazeret">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Mazeret İzni</h6>
                                <h3 class="mb-0" id="ozetMazeret">0 gün</h3>
                                <small class="text-info">Toplam</small>
                            </div>
                            <div class="text-info">
                                <i class="fas fa-hands-helping fa-3x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- İzin Listesi -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> İzin Kayıtları</h5>
            </div>
            <div class="card-body">
                <div id="izinListesi">
                    <p class="text-center text-muted py-4">
                        <i class="fas fa-info-circle"></i> Lütfen filtre uygulayın ve arama yapın
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- İzin Ekleme Modal -->
    <div class="modal fade" id="izinModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Yeni İzin Ekle</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="izinForm">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Personel <span class="text-danger">*</span></label>
                                <select class="form-select" id="izinPersonel" required onchange="personelSecildi()">
                                    <option value="">Seçiniz...</option>
                                    {% for p in personeller %}
                                    <option value="{{ p.id }}">{{ p.ad }} {{ p.soyad }}</option>
                                    {% endfor %}
                                </select>
                                <div id="yillikIzinBilgi" class="alert alert-info mt-2" style="display:none;">
                                    <i class="fas fa-info-circle"></i> <span id="yillikIzinMesaj"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">İzin Tipi <span class="text-danger">*</span></label>
                                <select class="form-select" id="izinTipi" required onchange="izinTipiDegisti()">
                                    <option value="">Seçiniz...</option>
                                    <option value="yillik">Yıllık İzin (Ücretli)</option>
                                    <option value="ucretsiz">Ücretsiz İzin</option>
                                    <option value="hastalik">Hastalık İzni</option>
                                    <option value="mazeret">Mazeret İzni (Ücretli)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Gün Sayısı <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="gunSayisi" step="0.5" min="0.5" required onchange="gunSayisiDegisti()">
                                <small class="text-muted">Yarım gün için 0.5 girin</small>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Başlangıç Tarihi <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="baslangicTarihi" required onchange="tarihDegisti()">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bitiş Tarihi <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="bitisTarihi" required onchange="tarihDegisti()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="ucretliMi" checked>
                                    <label class="form-check-label" for="ucretliMi">
                                        <strong>Ücretli İzin</strong> (Maaştan kesinti yapılmayacak)
                                    </label>
                                </div>
                                <small class="text-muted" id="ucretliIpucu"></small>
                            </div>
                        </div>
                        <div class="row mb-3" id="yillikKotaRow" style="display:none;">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="yillikKotaDus" checked>
                                    <label class="form-check-label" for="yillikKotaDus">
                                        <strong>Yıllık izin kotasından düş</strong>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Açıklama</label>
                                <textarea class="form-control" id="aciklama" rows="3" placeholder="İzin nedeni veya ek bilgiler..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="izinKaydet()">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let izinModal;
        let mevcutYillikDurum = null;

        document.addEventListener('DOMContentLoaded', function() {
            izinModal = new bootstrap.Modal(document.getElementById('izinModal'));
            initializePage();
        });

        function initializePage() {
            const currentYear = new Date().getFullYear();
            const yilSelect = document.getElementById('filterYil');
            
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yilSelect.appendChild(option);
            }

            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('filterBaslangic').value = firstDay.toISOString().split('T')[0];
            document.getElementById('filterBitis').value = lastDay.toISOString().split('T')[0];

            izinListele();
        }

        function izinListele() {
            const personel = document.getElementById('filterPersonel').value;
            const izinTipi = document.getElementById('filterIzinTipi').value;
            const baslangic = document.getElementById('filterBaslangic').value;
            const bitis = document.getElementById('filterBitis').value;

            const params = new URLSearchParams();
            if (personel) params.append('personel_id', personel);
            if (izinTipi) params.append('izin_tipi', izinTipi);
            if (baslangic) params.append('baslangic', baslangic);
            if (bitis) params.append('bitis', bitis);

            fetch(`/api/izin/liste?${params}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        renderIzinListesi(data.data);
                        ozetHesapla(data.data);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showAlert('danger', 'Hata', 'İzinler yüklenemedi');
                });
        }

        function renderIzinListesi(izinler) {
            const container = document.getElementById('izinListesi');

            if (izinler.length === 0) {
                container.innerHTML = '<p class="text-center text-muted py-4">Bu kriterlere uygun izin bulunamadı</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead class="table-dark"><tr>';
            html += '<th>Personel</th><th>İzin Tipi</th><th>Tarih</th><th>Gün</th><th>Durum</th><th>Açıklama</th><th>İşlem</th>';
            html += '</tr></thead><tbody>';

            izinler.forEach(izin => {
                const tip = getIzinTipBadge(izin.izin_tipi);
                const ucretli = izin.ucretli_mi ? '<span class="badge bg-success">Ücretli</span>' : '<span class="badge bg-danger">Kesintili</span>';
                
                html += '<tr>';
                html += `<td><strong>${izin.ad} ${izin.soyad}</strong></td>`;
                html += `<td>${tip}</td>`;
                html += `<td>${formatDate(izin.baslangic_tarihi)} - ${formatDate(izin.bitis_tarihi)}</td>`;
                html += `<td><strong>${izin.gun_sayisi}</strong> gün</td>`;
                html += `<td>${ucretli}</td>`;
                html += `<td>${izin.aciklama || '-'}</td>`;
                html += `<td><button class="btn btn-sm btn-danger" onclick="izinSil(${izin.id}, '${izin.ad} ${izin.soyad}')"><i class="fas fa-trash"></i></button></td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function ozetHesapla(izinler) {
            let yillik = 0, yillikKullanilan = 0;
            let ucretsiz = 0;
            let hastalik = 0;
            let mazeret = 0;

            izinler.forEach(izin => {
                const gun = parseFloat(izin.gun_sayisi);
                
                if (izin.izin_tipi === 'yillik') {
                    if (izin.yillik_izin_kullanimi) yillikKullanilan += gun;
                } else if (izin.izin_tipi === 'ucretsiz') {
                    ucretsiz += gun;
                } else if (izin.izin_tipi === 'hastalik') {
                    hastalik += gun;
                } else if (izin.izin_tipi === 'mazeret') {
                    mazeret += gun;
                }
            });

            document.getElementById('ozetYillik').textContent = `${yillikKullanilan} gün`;
            document.getElementById('ozetUcretsiz').textContent = `${ucretsiz} gün`;
            document.getElementById('ozetHastalik').textContent = `${hastalik} gün`;
            document.getElementById('ozetMazeret').textContent = `${mazeret} gün`;
        }

        function yeniIzinModal() {
            document.getElementById('izinForm').reset();
            document.getElementById('yillikIzinBilgi').style.display = 'none';
            document.getElementById('yillikKotaRow').style.display = 'none';
            mevcutYillikDurum = null;
            izinModal.show();
        }

        function personelSecildi() {
            const personelId = document.getElementById('izinPersonel').value;
            if (!personelId) return;

            fetch(`/api/izin/yillik_durum/${personelId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        mevcutYillikDurum = data.data;
                        document.getElementById('yillikIzinMesaj').textContent = 
                            `Yıllık İzin: ${data.data.kullanilan}/${data.data.toplam_hak} gün kullanılmış. Kalan: ${data.data.kalan} gün`;
                        document.getElementById('yillikIzinBilgi').style.display = 'block';
                    }
                });
        }

        function izinTipiDegisti() {
            const tip = document.getElementById('izinTipi').value;
            const ucretliCheckbox = document.getElementById('ucretliMi');
            const yillikRow = document.getElementById('yillikKotaRow');
            const ipucu = document.getElementById('ucretliIpucu');

            if (tip === 'yillik') {
                ucretliCheckbox.checked = true;
                yillikRow.style.display = 'block';
                document.getElementById('yillikKotaDus').checked = true;
                ipucu.textContent = 'Yıllık izin genellikle ücretlidir';
            } else if (tip === 'ucretsiz') {
                ucretliCheckbox.checked = false;
                yillikRow.style.display = 'none';
                ipucu.textContent = 'Ücretsiz izin maaştan kesilir';
            } else if (tip === 'hastalik') {
                ucretliCheckbox.checked = true;
                yillikRow.style.display = 'none';
                ipucu.textContent = 'İlk 2 güne kadar kesintisiz (ard arda)';
            } else if (tip === 'mazeret') {
                ucretliCheckbox.checked = true;
                yillikRow.style.display = 'none';
                ipucu.textContent = 'Mazeret izni kesintisizdir';
            }

            gunSayisiDegisti();
        }

        function tarihDegisti() {
            const baslangic = document.getElementById('baslangicTarihi').value;
            const bitis = document.getElementById('bitisTarihi').value;

            if (baslangic && bitis) {
                const start = new Date(baslangic);
                const end = new Date(bitis);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                document.getElementById('gunSayisi').value = days > 0 ? days : 1;
                gunSayisiDegisti();
            }
        }

        function gunSayisiDegisti() {
            const tip = document.getElementById('izinTipi').value;
            const gun = parseFloat(document.getElementById('gunSayisi').value) || 0;

            if (tip === 'yillik' && mevcutYillikDurum) {
                if (gun > mevcutYillikDurum.kalan) {
                    showAlert('warning', 'Uyarı', `Yetersiz yıllık izin! Kalan: ${mevcutYillikDurum.kalan} gün`);
                }
            }
        }

        function izinKaydet() {
            const form = document.getElementById('izinForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const data = {
                personel_id: parseInt(document.getElementById('izinPersonel').value),
                izin_tipi: document.getElementById('izinTipi').value,
                baslangic_tarihi: document.getElementById('baslangicTarihi').value,
                bitis_tarihi: document.getElementById('bitisTarihi').value,
                gun_sayisi: parseFloat(document.getElementById('gunSayisi').value),
                ucretli_mi: document.getElementById('ucretliMi').checked,
                yillik_izin_kullanimi: document.getElementById('yillikKotaDus') ? document.getElementById('yillikKotaDus').checked : false,
                aciklama: document.getElementById('aciklama').value
            };

            fetch('/api/izin/ekle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    showAlert('success', 'Başarılı', 'İzin başarıyla kaydedildi');
                    izinModal.hide();
                    izinListele();
                } else {
                    showAlert('danger', 'Hata', response.error);
                }
            })
            .catch(err => {
                console.error(err);
                showAlert('danger', 'Hata', 'İzin kaydedilemedi');
            });
        }

        function izinSil(izinId, personelAdi) {
            if (!confirm(`${personelAdi} personelinin izin kaydını silmek istediğinizden emin misiniz?`)) {
                return;
            }

            fetch(`/api/izin/sil/${izinId}`, {
                method: 'DELETE'
            })
            .then(r => r.json())
            .then(response => {
                if (response.success) {
                    showAlert('success', 'Başarılı', 'İzin kaydı silindi');
                    izinListele();
                } else {
                    showAlert('danger', 'Hata', response.error);
                }
            })
            .catch(err => {
                console.error(err);
                showAlert('danger', 'Hata', 'İzin silinemedi');
            });
        }

        function excelExport() {
            const yil = document.getElementById('filterYil').value;
            window.location.href = `/api/izin/excel_export?donem_yil=${yil}`;
        }

        function getIzinTipBadge(tip) {
            const badges = {
                'yillik': '<span class="badge bg-success">Yıllık</span>',
                'ucretsiz': '<span class="badge bg-danger">Ücretsiz</span>',
                'hastalik': '<span class="badge bg-warning">Hastalık</span>',
                'mazeret': '<span class="badge bg-info">Mazeret</span>'
            };
            return badges[tip] || tip;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('tr-TR');
        }

        function showAlert(type, title, message) {
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 350px;">
                    <h6 class="alert-heading">${title}</h6>
                    <p class="mb-0">${message}</p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHTML);
            setTimeout(() => document.querySelector('.alert')?.remove(), 5000);
        }
    </script>
</body>
</html>